
<script type="text/javascript">

const bg_gradient = "background: -moz-linear-gradient(top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1) 15px, hsla(#, 100%, 98%, 1) 15px, hsla(#, 100%, 98%, 1));";
const bg_color = "background-color: hsl(#, 100%, 98%);";

var body = document.getElementById("ibcontent");


function setColors(target)
{
  var senderColor = target.getAttribute("senderColor");

  if (senderColor) {
    var regexp = /color:\s*hsl\(\s*(\d{1,3})\s*,\s*\d{1,3}\%\s*,\s*\d{1,3}\%\s*\)/;
    var parsed = regexp.exec(senderColor);

    if (parsed) {
      var senderHue = parsed[1];
      target.setAttribute("style", bg_gradient.replace("#", senderHue, "g"));
    }
  }

  if (body.scrollHeight <= screen.height) {
    if (senderHue) {
      body.setAttribute("style", bg_color.replace("#", senderHue));
    }
    else if (target.className.indexOf("outgoing") > -1) {
      body.className = "outgoing-color";
      body.removeAttribute("style");
    }
    else if (target.className.indexOf("incoming") > -1) {
      body.className = "incoming-color";
      body.removeAttribute("style");
    }
    else if (target.className.indexOf("event") > -1) {
      body.className = "event-color";
      body.removeAttribute("style");
    }
  }
}


function addCSS(aFileName, aId)
{
  var new_css = document.createElement("link");

  new_css.setAttribute("rel", "stylesheet");
  new_css.setAttribute("type", "text/css");
  new_css.setAttribute("href", aFileName);
  new_css.setAttribute("id", aId);

  document.getElementsByTagName("head")[0].appendChild(new_css);
}


function adaptCSS(aEvent)
{
  var medium_css = document.getElementById("medium_css");
  var minimal_css = document.getElementById("minimal_css");
  var tight_css = document.getElementById("tight_css");

  if (body.clientWidth < 400 && !medium_css)
    addCSS("CSS/medium.css", "medium_css");
  else if (body.clientWidth >= 400 && medium_css)
    document.getElementsByTagName("head")[0].removeChild(medium_css);

  if (body.clientWidth < 200 && !minimal_css)
    addCSS("CSS/minimal.css", "minimal_css");
  else if (body.clientWidth >= 200 && minimal_css)
    document.getElementsByTagName("head")[0].removeChild(minimal_css);

  if (body.clientHeight < 200 && !tight_css)
    addCSS("CSS/tight.css", "tight_css");
  else if (body.clientHeight >= 200 && tight_css)
    document.getElementsByTagName("head")[0].removeChild(tight_css);
}


function groupEvents(parent)
{
  var list = parent.getElementsByTagName("p");
  if (list.length < 3)
    return;

  if (list[1].hasAttribute("style")) {
    var prevStyle = list[1].style.display;

    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = prevStyle;
  }
  else {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "none";

    var div = document.createElement("div");
    div.setAttribute("onclick", "toggle_groupEvents(event)");
    div.setAttribute("class", "button hide");
    parent.insertBefore(div, list[0]);

    list[0].lastChild.className += " first-event";
  }
}


function toggle_groupEvents(aEvent)
{
  var button = aEvent.target;
  var list = button.parentNode.getElementsByTagName("p");

  if (button.className == "button hide") {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "block";

    button.className = "button show";

    var oldClass = list[0].lastChild.className;
    list[0].lastChild.className = oldClass.substr(0, oldClass.length - 12);
  }
  else {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "none";

    button.className = "button hide";

    list[0].lastChild.className += " first-event";
  }
}


const fade_speed = 30;

var smoothDisplay = {
  toggle: function SDtoggle(aTarget, control) {
    var target = aTarget.getElementsByClassName("date-next")[0];

    if (!("control" in target) || !("minOpacity" in target)) {
      target.control = 0;
      target.minOpacity = parseFloat(document.defaultView.getComputedStyle(target, null).opacity);
    }

    if (target.control == 0) {
      target.control = control;
      setTimeout (smoothDisplay.progress, fade_speed, target);
    }
    else {
      target.control = control;
    }
  },

  progress: function SDprogress(target) {
    var targetOpacity = parseFloat(document.defaultView.getComputedStyle(target, null).opacity);

    if ((target.control < 0 && targetOpacity > target.minOpacity) || (target.control > 0 && targetOpacity < 1.0)) {
      target.style.opacity = targetOpacity + 0.1 * target.control;
      setTimeout(smoothDisplay.progress, fade_speed, target);
    }
    else {
      target.control = 0;
    }
  }
};


function checkNewText(aEvent)
{
  var target = aEvent.originalTarget;
  if (!(target instanceof HTMLElement))
    return;

  if (target.tagName == "DIV")
    setColors(target);
  else if (target.tagName == "P" && target.className == "event")
    groupEvents(target.parentNode);
}


window.addEventListener("resize", adaptCSS);
adaptCSS(null);

document.getElementById("ibcontent")
        .addEventListener("DOMNodeInserted", checkNewText);
</script>
